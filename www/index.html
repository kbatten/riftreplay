<!DOCTYPE html>
<html>
  <!--
    references:
      http://www.html5rocks.com/tutorials/file/dndfiles/
      https://developer.mozilla.org/en/using_files_from_web_applications
  -->
  <!--
    todo:
      for large files, firefox is giving warnings about script time, need to chunk the input data
      have a spinner while compressing, and add status message
      sendData is saying that the file is uploaded before its even compressed
  -->
  <head>
    <script type="text/javascript" src="/static/js-deflate/rawdeflate.js"></script>
    <style>
      #drop_zone {
      border: 2px dashed #bbb;
      -moz-border-radius: 5px;
      -webkit-border-radius: 5px;
      border-radius: 5px;
      padding: 25px;
      text-align: center;
      font: 20pt bold 'Vollkorn';
      color: #bbb;
      }
    </style>
  </head>
  <body>
    <div id="drop_zone">Drop rift log here</div>
    <output id="filename"></output><br>
    <output id="logname"></output><br>
    <output id="status"></output><br>
    <output id="percent"></output><br>
    <output id="debug"></output><br>

    <script>
  $ = function(id) { return document.getElementById(id); }

  g_uploading = false;

  function adler32(data) {
    a = 1;
    b = 0;
    for (i=0;i<data.length;i++) {
      ascii = data.charCodeAt(i);
      a = (a + ascii) % 65521
      b = (a + b) % 65521
    }
    a0 = a >>> 8
    a1 = a & 255
    b0 = b >>> 8
    b1 = b & 255

    r = [String.fromCharCode(b0),String.fromCharCode(b1),String.fromCharCode(a0),String.fromCharCode(a1)]
    return r.join("")
  }

  function compressData(data) {
    // deflated data does not have the zlib header or data checksum
    // second part of the header is most likely not correct
    header = String.fromCharCode(0x78) + String.fromCharCode(0x01)
    raw_compressed = RawDeflate.deflate(data)
    checksum = adler32(data)
    compressed = header + raw_compressed + checksum;
    return compressed;
  }

  // modified from https://developer.mozilla.org/en/using_files_from_web_applications
  // sends data in base64
  function sendData(raw_data) {
    data = btoa(raw_data)
    dataSize = data.length;
    boundary = "yyyyyyyyyyyyyyyyyyyyyyy";
    uri = "/upload";
    xhr = new XMLHttpRequest();

    // build up a fake Mime message, lots of parts to make sure server side can handle it
    // server should only care about the Filedata part
    var body = "--" + boundary + "\r\n";
    body += "Content-Disposition: form-data; name=\"Filename\"\r\n\r\n";
    body += "fake.txt\r\n";
    body += "--" + boundary + "\r\n";
    body += "Content-Disposition: form-data; name=\"Filedata\"; filename=\"fake.txt\"\r\n";
    body += "Content-Type: application/octet-stream\r\n\r\n";
    body += data + "\r\n";
    body += "--" + boundary + "\r\n";
    body += "Content-Disposition: form-data; name=\"Upload\"\r\n\r\n";
    body += "Submit Query\r\n";
    body += "--" + boundary + "--";

    xhr.open("POST", uri, true);
    xhr.setRequestHeader("Content-Type", "multipart/form-data; boundary="+boundary);
    xhr.setRequestHeader("Content-Length", body.length);

    xhr.onreadystatechange = function() {
      if (xhr.readyState == 4) {
        if (xhr.status == 200) {
          $('logname').innerHTML = xhr.responseText;
          if (xhr.responseText) {
            g_uploading = false;
            $('status').innerHTML = "uploaded";
            window.location.href = 'results/' + xhr.responseText;
          }
        } else {
          $('status').innerHTML = "error";
          g_uploading = false;
        }
      } else {
        $('status').innerHTML = "uploading";
      }
    }

    xhr.send(body);
  }

  function handleFileSelect(evt) {
    evt.stopPropagation();
    evt.preventDefault();

    if (g_uploading == true) {
      return;
    }
    g_uploading = true;

    var f = evt.dataTransfer.files[0]; // Grab just the first file as a File object
    var reader = new FileReader();

    $('filename').innerHTML = f.name;

    reader.onload = function(e) {
      sendData(compressData(e.target.result));
   }

    reader.readAsText(f);
  }

  function handleDragOver(evt) {
    evt.stopPropagation();
    evt.preventDefault();
  }

  // Setup the dnd listeners.
  $('drop_zone').addEventListener('dragover', handleDragOver, false);
  $('drop_zone').addEventListener('drop', handleFileSelect, false);
    </script>

    riftreplay@gmail.com

  </body>
</html>
